---
title: "environmental_data_plots"
author: "allyson_demerlis"
date: "2024-03-18"
output: html_document
---

```{r}
library(dbplyr)
library(tidyverse)
library(readr)
library(stringr)
# library(gridExtra)
# library(grid)
library(ggplot2)
# library(lattice)
# library(Rmisc)
library(doBy)
library(devtools)
#devtools::install_github("ricardo-bion/ggradar", dependencies = TRUE)
library(ggradar)
#library(ggiraphExtra)
library(tidyverse)
#library(scales)
library(tidyr)
library(readxl)
library(zoo)
library(ggpubr)
```


# import files

## CURES frame tilt meter
```{r}
cures_frame_tilt_temp <- read_excel("raw_data/Oct2020_Jan2022_1901102_urban-2020-10_(0)_Temperature.xlsx", sheet = "1901102_urban-2020-10_(0)_Tempe")
#logged every 15 min

#edit cures frame time
cures_frame_tilt_temp$Datetime <- as.POSIXct(cures_frame_tilt_temp$Datetime, tz="UTC")
cures_frame_tilt_temp$Datetime_EST <- with_tz(cures_frame_tilt_temp$Datetime, "America/New_York")

# Filter the data to select time points at 2-hour intervals
cures_frame_tilt_temp <- cures_frame_tilt_temp %>%
  filter(minute(Datetime_EST) == 0 & (hour(Datetime_EST) %% 2 == 0))

#add cures frame site
cures_frame_tilt_temp %>% 
  mutate(site = "CURES_tilt") %>% 
  dplyr::select(!Date:Datetime) %>% 
  dplyr::rename(Temperature = `Temperature (C)`) -> cures_frame_tilt_temp

max(cures_frame_tilt_temp$Datetime_EST) #"2022-02-01 12:00:00 EST"
min(cures_frame_tilt_temp$Datetime_EST) #"2020-10-12 20:00:00 EDT"
```

plot all data to visualize
```{r}
ggplot(cures_frame_tilt_temp, aes(x=Datetime_EST, y=Temperature)) +
  geom_point()
```

ARCHIVE
```{r}
#filter out first two days because it was logging very high (abnormal) numbers
cures_frame_tilt_temp %>% 
  filter(Datetime_EST >= "2020-10-13 14:00:00") -> cures_frame_tilt_temp

cures_frame_tilt_temp %>% 
  group_by(Datetime_EST) %>% 
  dplyr::mutate(Temperature = mean(Temperature)) %>% 
  distinct() -> cures_frame_tilt_temp

#temps after this date start looking off and like the tiltmeter is mis-reading it
cures_frame_tilt_temp %>% 
  filter(as.Date(Datetime_EST) <= "2021-12-07")  -> cures_frame_tilt_temp

str(cures_frame_tilt_temp)
#Temperature
#Datetime_EST (ymd_hms)
#site

# Define the window size (e.g., for a couple of days, window_size = 2)
window_size <- 3

# Calculate the rolling maximum temperature within the specified range
cures_data<- cures_frame_tilt_temp %>%
  drop_na(Temperature) %>% 
  separate(Datetime_EST, into = c("Date", "Time"), sep = " ") %>% 
  mutate(Time = hms(Time)) %>% 
  mutate(Time_of_day = case_when(Time >= "7 H" & Time <= "18 H" ~ "Day",
                                 TRUE ~ "Night")) %>% 
  dplyr::group_by(Date, Time_of_day) %>% 
  dplyr::mutate(mean_temp_day = mean(Temperature)) %>% 
  arrange(Date) %>%
  mutate(RollingMax = rollmax(mean_temp_day, window_size, fill = NA, align = "right"),
         RollingMin = rollapply(mean_temp_day, window_size, min, fill = NA, align = "right"),
         MaxThreshold = RollingMax + 1,
         MinThreshold = RollingMin - 1)

# Filter out temperatures exceeding the threshold (+3 degrees from the rolling max)
filtered_cures_data <- cures_data %>%
  filter(Temperature <= MaxThreshold & Temperature >= MinThreshold)

filtered_cures_data %>% 
  ggplot(., aes(x=as.Date(Date), y=Temperature, color=site)) +
  geom_point()
  #ok this looks better

filtered_cures_data$Date <- ymd(filtered_cures_data$Date)

rows_to_replace <- grepl("0S", filtered_cures_data$Time) & !grepl("H|M", filtered_cures_data$Time)

filtered_cures_data$Time <- as.character(filtered_cures_data$Time)

filtered_cures_data$Time[rows_to_replace] <- gsub("0S", "00:00:00", filtered_cures_data$Time[rows_to_replace])

filtered_cures_data %>% 
  unite(Datetime_EST, Date, Time, sep = " ") %>% 
  mutate(Datetime_EST = ymd_hms(Datetime_EST)) -> filtered_cures_data
```

## CCC HOBO (Lirman lab)
```{r}
CCC_hobo <- read_csv("raw_data/CCC_HOBO.csv", skip = 1)

convertFtoC <- function(F) {
  C <- (F - 32) * 5/9
  return(C)
}

CCC_hobo %>% 
  rename(Temperature = `Temp, °F (LGR S/N: 20261765, SEN S/N: 20261765)`) %>% 
  rename(Date_GMT = `Date Time, GMT-04:00`) %>% 
  select(Date_GMT, Temperature) %>% 
  mutate(site = "CCC_HOBO") %>% 
  mutate(Datetime_EST=with_tz(mdy_hms(Date_GMT, tz = "Etc/GMT+4"), tzone = "Etc/GMT+4")) %>% 
  mutate(Datetime_EST=with_tz(Datetime_EST, tzone = "America/New_York")) %>% 
  mutate(Temperature=convertFtoC(Temperature)) -> CCC_hobo
```

plot all data to visualize
```{r}
ggplot(CCC_hobo, aes(x=Datetime_EST, y=Temperature)) +
  geom_point()
```


## CURES frame SeaFET
```{r}
CURES_SeaFET <- read_xlsx("raw_data/July_Dec_2020_seafet-sn303-tag3019-cures.xlsx", sheet = "C0000001")

CURES_SeaFET$Date

CURES_SeaFET %>% 
  select(Datetime,`0303-Temp`) %>% 
  drop_na() -> CURES_SeaFET

#edit cures frame time
CURES_SeaFET$Datetime <- as.POSIXct(CURES_SeaFET$Datetime, tz="UTC")
CURES_SeaFET$Datetime_EST <- with_tz(CURES_SeaFET$Datetime, "America/New_York")

# Filter the data to select time points at 2-hour intervals
CURES_SeaFET <- CURES_SeaFET %>%
  filter(minute(Datetime_EST) == 0 & (hour(Datetime_EST) %% 2 == 0))

CURES_SeaFET %>% 
  rename(Temperature = `0303-Temp`) %>% 
  mutate(site = "CURES_seaFET") -> CURES_SeaFET

min(CURES_SeaFET$Datetime_EST) #"2020-08-04 18:00:13 EDT"
```

plot all data to visualize
```{r}
ggplot(CURES_SeaFET, aes(x=Datetime_EST, y=Temperature)) +
  geom_point()
```

##join all CURES/CCC site in-situ temps
```{r}
full_join(cures_frame_tilt_temp, CCC_hobo) %>% 
  full_join(., CURES_SeaFET) %>% 
  dplyr::select(Temperature:site) %>% 
  ggplot(., aes(x=Datetime_EST, y=Temperature, color = site)) +
  geom_point(alpha = 0.7) +
  theme_bw() +
  scale_x_datetime(date_labels = "%b %Y",  # Customize the date format
                     date_breaks = "1 month") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
#ggsave("all_CCC_datatypes.png", width = 10, height = 7)
```

## virginia key buoy water temp data
```{r}
file_paths <- c("raw_data/virginiakeybuoy/vakf1h2020.txt", "raw_data/virginiakeybuoy/vakf1h2021.txt", "raw_data/virginiakeybuoy/vakf1h2022.txt")

process_file <- function(file_path) {
  data <- read.table(file_path, header = FALSE, sep = "", comment.char = "#", stringsAsFactors = FALSE)

# Read the first two lines to get the column names
lines <- read_lines(file_path, n_max = 2)

# Extract column names from the second line
column_names <- strsplit(lines[1], "\\s+")[[1]]

# Assign the column names to the data frame
colnames(data) <- column_names

data %>% 
  rename(Temperature = WTMP) %>% 
  select(`#YY`:mm,Temperature) -> data
  
data$Datetime <- ymd_hm(paste(data$`#YY`, data$MM, data$DD, data$hh, data$mm))

data$Datetime <- as.POSIXct(data$Datetime, tz="UTC")
data$Datetime_EST <- with_tz(data$Datetime, "America/New_York")

return(data)
}

# Initialize an empty list to store the processed data frames
all_data <- list()

# Loop over the file paths and process each file
for (file_path in file_paths) {
  data <- process_file(file_path)
  all_data[[file_path]] <- data
}

# Optionally, combine all data frames into one, if needed
combined_data <- do.call(rbind, all_data)

# View the combined data
print(combined_data)

combined_data %>% 
  select(Temperature, Datetime_EST) %>% 
  mutate(site = "VK_Buoy") -> vkbuoydata

rownames(vkbuoydata) <- NULL

#VK_Buoy data gets written as "999" if there is no available data for that time point, so filter that out

vkbuoydata %>% 
  filter(Temperature < 999) -> vkbuoydata

# Filter the data to select time points at 2-hour intervals
vkbuoydata <- vkbuoydata %>%
  filter(minute(Datetime_EST) == 0 & (hour(Datetime_EST) %% 2 == 0))
```

```{r}
ggplot(vkbuoydata, aes(x=Datetime_EST, y=Temperature)) +
  geom_point()
```



## join VK data with insitu data
```{r}
full_join(cures_frame_tilt_temp, CCC_hobo) %>% 
  full_join(., CURES_SeaFET) %>% 
  full_join(vkbuoydata) %>% 
  dplyr::select(Temperature:site) %>% 
  filter(Datetime_EST < "2022-02-01 12:00:00" & Datetime_EST > "2020-08-04 18:00:13") %>% 
  #filter time frame with greatest overlap
  ggplot(., aes(x=Datetime_EST, y=Temperature, color = site)) +
  geom_line(alpha = 0.7) +
  theme_bw() +
  scale_x_datetime(date_labels = "%b %Y",  # Customize the date format
                     date_breaks = "1 month") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
#ggsave("allnearshoretempdata.png", width = 10, height = 7)
```

## experimental period
```{r}
full_join(cures_frame_tilt_temp, vkbuoydata) %>% 
  dplyr::select(Temperature:site) %>% 
  filter(as.Date(Datetime_EST) < "2021-12-01" & as.Date(Datetime_EST) > "2021-06-23") %>% 
  #filter time frame with greatest overlap
  ggplot(., aes(x=Datetime_EST, y=Temperature, color = site)) +
  geom_point(alpha = 0.7) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#ggsave("tiltmeter_VKbuoy.png", width = 10, height = 7)

#no visual outliers, so nothing will be filtered out 
```


## KB Nursery HOBOs
```{r}
#HOBO logs every two hours
KB_01092018<-read_csv("raw_data/KBNursery_2018_01_09.csv", skip = 1)
convertFtoC <- function(F) {
  C <- (F - 32) * 5/9
  return(C)
}
KB_01092018  %>% 
  dplyr::select(!`#`) %>% 
  mutate(Datetime_EST=with_tz(mdy_hms(`Date Time, GMT-05:00`, tz = "Etc/GMT+5"), tzone = "Etc/GMT+5")) %>% 
  mutate(Datetime_EST=with_tz(Datetime_EST, tzone = "America/New_York")) %>% 
  dplyr::rename(Temperature = `Temp, °F (LGR S/N: 20194578, SEN S/N: 20194578)`) %>% 
  dplyr::rename(Light = `Intensity, lum/ft² (LGR S/N: 20194578, SEN S/N: 20194578)`) %>% 
  dplyr::select(Temperature, Light, Datetime_EST) %>% 
  mutate(Temperature=convertFtoC(Temperature)) -> KB_01092018

KB_07092019<-read_csv("raw_data/KBNursery_2019_07_09.csv", skip = 1)
KB_07092019  %>% 
  dplyr::select(!`#`) %>% 
  mutate(Datetime_EST=with_tz(mdy_hms(`Date Time, GMT-04:00`, tz = "Etc/GMT+4"), tzone = "Etc/GMT+4")) %>% 
  mutate(Datetime_EST=with_tz(Datetime_EST, tzone = "America/New_York")) %>% 
  dplyr::rename(Temperature = `Temp, °C (LGR S/N: 10795158, SEN S/N: 10795158)`) %>% 
  dplyr::rename(Light = `Intensity, lum/ft² (LGR S/N: 10795158, SEN S/N: 10795158)`) %>% 
  dplyr::select(Temperature, Light, Datetime_EST) -> KB_07092019

KB_10152019<-read_csv("raw_data/KBNursery_2019_10_15.csv", skip = 1)
KB_10152019 %>% 
  dplyr::select(!`#`) %>% 
  mutate(Datetime_EST=with_tz(mdy_hms(`Date Time, GMT-04:00`, tz = "Etc/GMT+4"), tzone = "Etc/GMT+4")) %>% 
  mutate(Datetime_EST=with_tz(Datetime_EST, tzone = "America/New_York")) %>% 
  dplyr::rename(Temperature = `Temp, °C (LGR S/N: 20518526, SEN S/N: 20518526)`) %>% 
  dplyr::rename(Light = `Intensity, lum/ft² (LGR S/N: 20518526, SEN S/N: 20518526)`) %>% 
  dplyr::select(Temperature, Light, Datetime_EST) -> KB_10152019

KB_01162020<-read_csv("raw_data/KBNursery_2020_01_16.csv", skip = 1)
KB_01162020 %>% 
  dplyr::select(!`#`) %>% 
  mutate(Datetime_EST=with_tz(mdy_hms(`Date Time, GMT-05:00`, tz = "Etc/GMT+5"), tzone = "Etc/GMT+5")) %>% 
  mutate(Datetime_EST=with_tz(Datetime_EST, tzone = "America/New_York")) %>% 
  dplyr::rename(Temperature = `Temp, °C (LGR S/N: 20473194, SEN S/N: 20473194)`) %>% 
  dplyr::rename(Light = `Intensity, lum/ft² (LGR S/N: 20473194, SEN S/N: 20473194)`) %>% 
  dplyr::select(Temperature, Light, Datetime_EST) -> KB_01162020

KB_03062020<-read_csv("raw_data/KBNursery_2020_03_06.csv", skip = 1)
KB_03062020 %>% 
  mutate(Datetime_EST=with_tz(mdy_hms(`Date Time, GMT-05:00`, tz = "Etc/GMT+5"), tzone = "Etc/GMT+5")) %>% 
  mutate(Datetime_EST=with_tz(Datetime_EST, tzone = "America/New_York")) %>% 
  dplyr::rename(Temperature = `Temp, °C (LGR S/N: 20685544, SEN S/N: 20685544)`) %>% 
  dplyr::rename(Light = `Intensity, lum/ft² (LGR S/N: 20685544, SEN S/N: 20685544)`) %>% 
  dplyr::select(Temperature, Light, Datetime_EST) -> KB_03062020

KB_05012020<-read_csv("raw_data/KBNursery_2020_05_01.csv", skip = 1)
KB_05012020 %>% 
  mutate(Datetime_EST=with_tz(mdy_hms(`Date Time, GMT-04:00`, tz = "Etc/GMT+4"), tzone = "Etc/GMT+4")) %>% 
  mutate(Datetime_EST=with_tz(Datetime_EST, tzone = "America/New_York")) %>% 
  dplyr::rename(Temperature = `Temp, °C (LGR S/N: 20685559, SEN S/N: 20685559)`) %>% 
  dplyr::rename(Light = `Intensity, lum/ft² (LGR S/N: 20685559, SEN S/N: 20685559)`) %>% 
  dplyr::select(Temperature, Light, Datetime_EST) -> KB_05012020

KB_09112020<-read_csv("raw_data/KBNursery_2020_09_11.csv", skip = 1)

KB_09112020 %>% 
  mutate(Datetime_EST=with_tz(mdy_hm(`Date Time, GMT-04:00`, tz = "Etc/GMT+4"), tzone = "Etc/GMT+4")) %>% 
  mutate(Datetime_EST=with_tz(Datetime_EST, tzone = "America/New_York")) %>% 
  dplyr::rename(Temperature = `Temp, °C (LGR S/N: 20597589, SEN S/N: 20597589)`) %>% 
  dplyr::rename(Light = `Intensity, lum/ft² (LGR S/N: 20597589, SEN S/N: 20597589)`) %>% 
  dplyr::select(Temperature, Light, Datetime_EST) -> KB_09112020

KB_02102021 <- read_csv("raw_data/KBNursery_2021_02_10.csv", skip = 1)
KB_02102021 %>% 
  mutate(Datetime_EST=with_tz(mdy_hms(`Date Time, GMT-05:00`, tz = "Etc/GMT+5"), tzone = "Etc/GMT+5")) %>% 
  mutate(Datetime_EST=with_tz(Datetime_EST, tzone = "America/New_York")) %>% 
  dplyr::rename(Temperature = `Temp, °C (LGR S/N: 20976501, SEN S/N: 20976501)`) %>% 
  dplyr::rename(Light = `Intensity, lum/ft² (LGR S/N: 20976501, SEN S/N: 20976501)`) %>% 
  dplyr::select(Temperature, Light, Datetime_EST) -> KB_02102021

KB_05282021 <- read_csv("raw_data/KBNursery_2021_05_28.csv", skip = 1)
KB_05282021 %>% 
  mutate(Datetime_EST=with_tz(mdy_hms(`Date Time, GMT-04:00`, tz = "Etc/GMT+4"), tzone = "Etc/GMT+4")) %>% 
  mutate(Datetime_EST=with_tz(Datetime_EST, tzone = "America/New_York")) %>% 
  dplyr::rename(Temperature = `Temp, °C (LGR S/N: 21085862, SEN S/N: 21085862)`) %>% 
  dplyr::select(Temperature, Datetime_EST) %>% 
  mutate(Light = NA) -> KB_05282021

KB_08112021 <- read_csv("raw_data/KBNursery_2021_08_11.csv", skip = 1)
KB_08112021 %>% 
  mutate(Datetime_EST=with_tz(mdy_hm(`Date Time, GMT-04:00`, tz = "Etc/GMT+4"), tzone = "Etc/GMT+4")) %>% 
  mutate(Datetime_EST=with_tz(Datetime_EST, tzone = "America/New_York")) %>% 
  dplyr::rename(Temperature = `Temp, °C (LGR S/N: 20831178, SEN S/N: 20831178)`) %>% 
  dplyr::rename(Light = `Intensity, lum/ft² (LGR S/N: 20831178, SEN S/N: 20831178)`) %>% 
  dplyr::select(Temperature, Light, Datetime_EST) -> KB_08112021

KB_120821 <- read_csv("raw_data/KBNursery_2021_12_08.csv", skip = 1)

KB_120821%>% 
  mutate(Datetime_EST=with_tz(mdy_hm(`Date Time, GMT-05:00`, tz = "Etc/GMT+5"), tzone = "Etc/GMT+5")) %>% 
  mutate(Datetime_EST=with_tz(Datetime_EST, tzone = "America/New_York")) %>% 
  dplyr::rename(Temperature = `Temp, °C (LGR S/N: 21236769, SEN S/N: 21236769)`) %>% 
  dplyr::rename(Light = `Intensity, lum/ft² (LGR S/N: 21236769, SEN S/N: 21236769)`) %>% 
  dplyr::select(Temperature, Light, Datetime_EST) -> KB_120821

rbind(KB_01092018, KB_07092019, KB_10152019, KB_01162020, KB_03062020, KB_05012020, KB_09112020, KB_02102021, KB_05282021, KB_08112021, KB_120821) -> all_KB_data

all_KB_data %>% 
  mutate(site = "Nursery") -> all_KB_data

all_KB_data$Temperature <- as.numeric(all_KB_data$Temperature)
```

plot all raw data
```{r}
  ggplot(all_KB_data, aes(x=Datetime_EST, y=Temperature, color = site)) +
  geom_point() +
  theme_bw() +
  scale_x_datetime(date_labels = "%b %Y",  # Customize the date format
                     date_breaks = "1 month") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
```

plot raw data within time frame of experiment
```{r}
full_join(all_KB_data, vkbuoydata) %>%  
  filter(as.Date(Datetime_EST) > "2021-06-23" & as.Date(Datetime_EST) < "2021-12-01") %>% 
  ggplot(., aes(x=Datetime_EST, y=Temperature, color = site)) +
  geom_point() +
  theme_bw() +
  scale_x_datetime(date_labels = "%b %Y",  # Customize the date format
                     date_breaks = "1 month") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
#ggsave("rawdata_KBnursery_VKbuoy.png", width = 10, height = 7)
```

look closely at some time frames
```{r}
full_join(all_KB_data, vkbuoydata) %>%  
  filter(as.Date(Datetime_EST) > "2021-05-31" & as.Date(Datetime_EST) < "2021-06-10") %>% 
  ggplot(., aes(x=Datetime_EST, y=Temperature, color = site)) +
  geom_point() +
  geom_line() +
  theme_bw() +
  scale_x_datetime(date_labels = "%b %Y",  # Customize the date format
                     date_breaks = "1 month") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# this part we can just filter out because it was before the experiment started anyways
# experiment started june 23 2021


full_join(all_KB_data, vkbuoydata) %>%  
  filter(as.Date(Datetime_EST) > "2021-08-10" & as.Date(Datetime_EST) < "2021-08-24") %>% 
  ggplot(., aes(x=Datetime_EST, y=Temperature, color = site)) +
  geom_point() +
  geom_line() +
  theme_bw() +
  scale_x_datetime(date_labels = "%b %Y",  # Customize the date format
                     date_breaks = "1 month") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# the temperature is oscillating like 5 degrees...
```

### outlier removal

```{r}
# Z-score method
all_KB_data %>% 
  filter(as.Date(Datetime_EST) > "2021-06-20") %>% #3,565 rows
  mutate(z_score = scale(Temperature)) %>% 
  filter(abs(z_score) < 3) -> filtered_KB_data #3,558 rows

filtered_KB_data %>% 
  dplyr::select(!z_score) %>% 
  filter(as.Date(Datetime_EST) > "2021-08-10" & as.Date(Datetime_EST) < "2021-08-24") %>% #301 
  filter(Temperature > 27 & Temperature < 31.5) %>%  #163 rows
  ggplot(., aes(x=Datetime_EST, y=Temperature, color = site)) +
  geom_point() +
  geom_line() +
  theme_bw() 

filtered_KB_data %>% 
  dplyr::select(!z_score) %>% 
  filter(as.Date(Datetime_EST) > "2021-08-10" & as.Date(Datetime_EST) < "2021-08-24") %>% #301 
  filter(Temperature > 27 & Temperature < 31.5) -> august_filtered_KB_data

filtered_KB_data %>% 
  filter(!(as.Date(Datetime_EST) > "2021-08-10" & as.Date(Datetime_EST) < "2021-08-24")) %>% 
  full_join(., august_filtered_KB_data) %>% 
  full_join(., vkbuoydata) %>% 
  filter(as.Date(Datetime_EST) < "2021-12-01" & as.Date(Datetime_EST) > "2021-06-20") %>% 
  ggplot(., aes(x=Datetime_EST, y=Temperature, color = site)) +
  geom_point() +
  geom_line() +
  theme_bw() 
#ggsave("filtered_KB_buoy_data.png", width = 10, height = 7)
```


## import CRW daily SST data from 2020-2021

```{r}
   # read all the .nc files 
    flist_2020<-list.files("raw_data/CRW_NOAA_data/daily/sst/2020",pattern='*.nc',full.names=TRUE)
  # i deleted any .nc files that were causing issues with importing (two files)
      
  # brick them 
    ras_2020<-lapply(flist_2020, stack)
    
   # KB Nursery
  lat_KB <- (25.6763)
  lon_KB <- (-80.0987)
  extract.pts_KB <- cbind(lon_KB,lat_KB)
  
  #CCC 
  lat.CCC <- (25.766626)
  lon.CCC <- (-80.144812)
  extract_CCC <- cbind(lon.CCC, lat.CCC)
  
  ## Extract data by coordinates 
    ext_nursery <- lapply(ras_2020,raster::extract,extract.pts_KB)
    head(ext_nursery)
    nursery_SST_2020 <- unlist(ext_nursery, recursive = FALSE)
    head(nursery_SST_2020)
    
  ## Extract data by coordinates 
    ext_CCC <- lapply(ras_2020,raster::extract,extract_CCC)
    head(ext_CCC)
    CCC_SST_2020 <- unlist(ext_CCC, recursive = FALSE)
    head(CCC_SST_2020)
    
     # read all the .nc files 
    flist_2021<-list.files("raw_data/CRW_NOAA_data/daily/sst/2021",pattern='*.nc',full.names=TRUE)
       # i deleted any .nc files that were causing issues with importing (two files)
    
  # brick them 
    ras_2021<-lapply(flist_2021, stack)
    
   # KB Nursery
  lat_KB <- (25.6763)
  lon_KB <- (-80.0987)
  extract.pts_KB <- cbind(lon_KB,lat_KB)
  
  #CCC 
  lat.CCC <- (25.766626)
  lon.CCC <- (-80.144812)
  extract_CCC <- cbind(lon.CCC, lat.CCC)
  
  ## Extract data by coordinates 
    ext_nursery <- lapply(ras_2021,raster::extract,extract.pts_KB)
    head(ext_nursery)
    nursery_SST_2021 <- unlist(ext_nursery, recursive = FALSE)
    head(nursery_SST_2021)
    
     ## Extract data by coordinates 
    ext_CCC <- lapply(ras_2021,raster::extract,extract_CCC)
    head(ext_CCC)
    CCC_SST_2021 <- unlist(ext_CCC, recursive = FALSE)
    head(CCC_SST_2021)
    
save(ras_2020, ras_2021, file = "combined_rasters.Rdata")
#need to also save the 2020 and 2021 nursery and CCC files next time, otherwise you have to rerun the raster::extract step which takes forever, especially for 2021
```

```{r}
# Create a date list 
    Dates_2020<-seq.Date(as.Date("2020-10-01"), as.Date("2020-12-29"), by = "day")
    Dates_2020<-as.character(Dates_2020)
    #head(Date)
      
# Bind GPS points and Dates    Date.location <- merge(pts, Date)
    nursery_SST_2020.data<-data.frame(Dates_2020, nursery_SST_2020)
    nursery_SST_2020.data$Date<-as.Date(nursery_SST_2020.data$Dates_2020)
    head(nursery_SST_2020.data)  
    nursery_SST_2020.data %>% 
      rename(Temperature = nursery_SST_2020) %>% 
      mutate(site = "Nursery") ->nursery_SST_2020.data
    
    CCC_SST_2020.data <- data.frame(Dates_2020, CCC_SST_2020)
    CCC_SST_2020.data$Date <- as.Date(CCC_SST_2020.data$Dates_2020)
    
    head(CCC_SST_2020.data)
    
    CCC_SST_2020.data %>% 
      rename(Temperature = CCC_SST_2020) %>% 
      mutate(site = "CCC") -> CCC_SST_2020.data
    
    Dates_2021<-seq.Date(as.Date("2021-01-01"), as.Date("2021-11-30"), by = "day")
    Dates_2021<-as.character(Dates_2021)
    #head(Date)
    
    nursery_SST_2021.data<-data.frame(Dates_2021, nursery_SST_2021)
    nursery_SST_2021.data$Date<-as.Date(nursery_SST_2021.data$Dates_2021)
    head(nursery_SST_2021.data)  
    nursery_SST_2021.data %>% 
      rename(Temperature = nursery_SST_2021) %>% 
      mutate(site = "Nursery") ->nursery_SST_2021.data
    
    CCC_SST_2021.data <- data.frame(Dates_2021, CCC_SST_2021)
    CCC_SST_2021.data$Date <- as.Date(CCC_SST_2021.data$Dates_2021)
    
    head(CCC_SST_2021.data)
    
    CCC_SST_2021.data %>% 
      rename(Temperature = CCC_SST_2021) %>% 
      mutate(site = "CCC") -> CCC_SST_2021.data
    
  full_join(nursery_SST_2020.data, nursery_SST_2021.data) %>% 
    select(!c(Dates_2020, Dates_2021)) %>% 
    full_join(., nursery_SST_2021.data) %>% 
    select(!Dates_2021) %>% 
    full_join(., CCC_SST_2021.data)%>% 
    select(!Dates_2021) -> CRW_SST_2020_2021
  
  # i forgot the CCC_SST_2020 dataset too....
  
  CRW_SST_2020_2021 <- read_csv("CRW_SST_2020_2021.csv")
  
  full_join(CRW_SST_2020_2021, CCC_SST_2020.data) %>% 
    select(!Dates_2020) %>% 
    arrange(Date) -> CRW_SST_2020_2021
  
  write_csv(CRW_SST_2020_2021, "CRW_SST_2020_2021.csv")
```


### ARCHIVE 

plotting and cleaning data 
```{r}
#there are some outliers in the KB Nursery data that need to be filtered out
all_KB_data %>% 
  separate(Datetime_EST, into = c("Date", "Time"), sep = " ") %>% 
  drop_na(Temperature) %>% 
  dplyr::group_by(Date) %>% 
  dplyr::mutate(mean_temp_day = mean(Temperature)) %>% 
  pivot_longer(c("Temperature", "mean_temp_day"), names_to = "name", values_to = "temp") %>% 
  ggplot(., aes(x=Date, y=temp, color=name)) +
  geom_point()
#lots of outliers
```

rolling max temp and filtering based on threshold of max
```{r}
# Define the window size (e.g., for a couple of days, window_size = 2)
window_size <- 3

# Calculate the rolling maximum temperature within the specified range
data <- all_KB_data %>%
  drop_na(Temperature) %>% 
  separate(Datetime_EST, into = c("Date", "Time"), sep = " ") %>% 
  mutate(Time = hms(Time)) %>% 
  mutate(Time_of_day = case_when(Time >= "7 H" & Time <= "18 H" ~ "Day",
                                 TRUE ~ "Night")) %>% 
  dplyr::group_by(Date, Time_of_day) %>% 
  dplyr::mutate(mean_temp_day = mean(Temperature)) %>% 
  arrange(Date) %>%
  mutate(RollingMax = rollmax(mean_temp_day, window_size, fill = NA, align = "right"),
         RollingMin = rollapply(mean_temp_day, window_size, min, fill = NA, align = "right"),
         MaxThreshold = RollingMax + 1,
         MinThreshold = RollingMin - 1)

# Filter out temperatures exceeding the threshold (+3 degrees from the rolling max)
filtered_data <- data %>%
  filter(Temperature <= MaxThreshold & Temperature >= MinThreshold)

filtered_data %>% 
  ggplot(., aes(x=as.Date(Date), y=Temperature, color=site)) +
  geom_point()
  #ok this looks better

filtered_data %>% 
  filter(Date >= "2019-07-01") -> filtered_data

rows_to_replace <- grepl("0S", filtered_data$Time) & !grepl("H|M", filtered_data$Time)

filtered_data$Time <- as.character(filtered_data$Time)

filtered_data$Time[rows_to_replace] <- gsub("0S", "00:00:00", filtered_data$Time[rows_to_replace])

filtered_data %>% 
  unite(Datetime_EST, Date, Time, sep = " ") %>% 
  mutate(Datetime_EST = ymd_hms(Datetime_EST)) -> filtered_data
```




# join both datasets and plot temps 
```{r}
filtered_KB_data %>% 
  filter(!(as.Date(Datetime_EST) > "2021-08-10" & as.Date(Datetime_EST) < "2021-08-24")) %>% 
  full_join(., august_filtered_KB_data) %>%
  full_join(., cures_frame_tilt_temp) %>%
 filter(as.Date(Datetime_EST) < "2021-12-01" & as.Date(Datetime_EST) > "2021-06-20") %>% 
  ggplot(., aes(x=Datetime_EST, y=Temperature, color = site)) +
  geom_line() +
  theme_bw() +
  labs(x="Date", y = "Temp (ºC)") +
  scale_color_manual(values = c("CURES_tilt" = "orange", "Nursery" = "darkblue"))
  #geom_hline(yintercept = 29.54, linetype = "dashed", color = "darkgrey") + 
  #geom_hline(yintercept = 30.54, linetype = "dashed", color = "darkgrey") 
#ggsave("CURES_nursery_temp.png", width=10, height = 7)
```


```{r}
filtered_KB_data %>% 
  filter(!(as.Date(Datetime_EST) > "2021-08-10" & as.Date(Datetime_EST) < "2021-08-24")) %>% 
  full_join(., august_filtered_KB_data) %>%
  full_join(., cures_frame_tilt_temp) %>%
 filter(as.Date(Datetime_EST) < "2021-12-01" & as.Date(Datetime_EST) > "2021-06-20") %>%  
  dplyr::select(!c(Light, z_score)) %>% 
  drop_na(Temperature) -> all_temp_data

#2021
#ian's code for season: phDataRaw$rDateTime[i]>"2020-5-26" && phDataRaw$rDateTime[i]<"2020-10-15"){phDataRaw$precipitation[i] = "wet"}
all_temp_data %>% 
  mutate(Season = case_when(as.Date(Datetime_EST) <= "2021-10-15" ~ "Wet",
                            as.Date(Datetime_EST) >= "2021-10-16" ~ "Dry")) %>% 
  dplyr::group_by(site, Season) %>%
  dplyr::summarise(mean_temp = mean(Temperature), sd_temp = sd(Temperature), min_temp = min(Temperature), max_temp = max(Temperature), count = n()) 

all_temp_data %>% 
  mutate(Season = case_when(as.Date(Datetime_EST) <= "2021-10-15" ~ "Wet",
                            as.Date(Datetime_EST) >= "2021-10-16" ~ "Dry")) %>% 
  dplyr::group_by(site, Season) %>%
  dplyr::summarise(mean_temp = mean(Temperature), sd_temp = sd(Temperature), min_temp = min(Temperature), max_temp = max(Temperature), count = n()) %>% 
  ggplot(., aes(x=Season,y=mean_temp,color=site)) +
  geom_point(position = position_dodge(width = 0.3)) + 
  geom_errorbar(aes(ymin=mean_temp-sd_temp, ymax=mean_temp+sd_temp, fill=site), width = 0.2,position = position_dodge(width = 0.3)) +
  theme_classic() +
  scale_color_manual(values = c("CURES_tilt" = "orange", "Nursery" = "darkblue")) 
```

# Radar plot (no DHW)

June 20, 2021 -- Dec 1, 2021
```{r}
#ian's code for season: phDataRaw$rDateTime[i]>"2020-5-26" && phDataRaw$rDateTime[i]<"2020-10-15"){phDataRaw$precipitation[i] = "wet"}

all_temp_data %>% 
  mutate(Season = case_when(as.Date(Datetime_EST) <= "2021-10-15" ~ "Wet",
                            as.Date(Datetime_EST) >= "2021-10-16" ~ "Dry")) -> alldata_2021
```

## temp summary (using hourly data)

### Site and Season (2021)
```{r}
temp.summary<- summaryBy(Temperature ~ site + Season, data = alldata_2021,
                         FUN = function(x) { c(max = max(x), min = min(x)) } )
temp.summary$Temp.seasonal <- temp.summary$Temperature.max - temp.summary$Temperature.min

alldata_2021 %>% 
  separate(Datetime_EST, into = c("Date", "Time"), sep = " ") -> alldata_2021_sep

# Daily Range
Daily.range <- summaryBy(Temperature ~ Date + site + Season, data=alldata_2021_sep, FUN=c(max,min,mean,sd))

Daily.range$temp.daily.range <- Daily.range$Temperature.max - Daily.range$Temperature.min

temp.d.range <- summaryBy(temp.daily.range ~ site + Season, data = Daily.range,
                          FUN = function(x) { c(mean = mean(x)) } )
Daily.range %>% 
  filter(Temperature.max > 30.5) %>% 
  group_by(site, Season) %>% 
  dplyr::summarise(d.above.30.5 = n()) -> temp.d.30.5

full_join(temp.summary, temp.d.range) %>% 
  full_join(., temp.d.30.5) -> temp_summary
```


```{r}
scale_by_max <- function(x) {
  x * 100 / max(x, na.rm = TRUE)
}

colnames(temp_summary) <- c("site", "Season", "Max", "Min", "Seasonal", "Daily", "30.5°C")

temp_summary %>% 
  filter(Season == "Dry") -> temp_summary_dry

temp_summary_dry %>% 
  column_to_rownames(var="site") %>% 
  dplyr::select(!Season) -> temp_summary_dry

 temp_summary_dry %>%
  dplyr::mutate(across(everything(), as.numeric)) %>%
  dplyr::select(!`30.5°C`) %>% 
  dplyr::mutate(across(everything(), scale_by_max)) -> temp_summary_dry_percent

# To use the fmsb package, I have to add 2 lines to the dataframe: the max and min of each variable to show on the plot!
temp_summary_dry_percent <- rbind(rep(100,5), rep(0,5), temp_summary_dry_percent)

# Color vector
colors_border=c("orange", "darkblue")
colors_in=c("orange", "darkblue")

# Define colors with transparency using adjustcolor
colors_border <- c(adjustcolor("orange", alpha = 0.9), adjustcolor("darkblue", alpha = 0.9))
colors_in <- c(adjustcolor("orange", alpha = 0.4), adjustcolor("darkblue", alpha = 0.4))

library(fmsb)
# plot with default options:
pdf("radarchart_dryseason.pdf")
radarchart(temp_summary_dry_percent, axistype=1 , 
            #custom polygon
            pcol=colors_border , pfcol=colors_in , plwd=4 , plty=1,
            #custom the grid
            cglcol="grey", cglty=1, axislabcol="grey", caxislabels=seq(0,100,25), cglwd=0.8,
            #custom labels
            vlcex=0.9
)

temp_summary %>% 
  filter(Season == "Wet") -> temp_summary_wet

temp_summary_wet %>% 
  column_to_rownames(var="site") %>% 
  dplyr::select(!Season) -> temp_summary_wet

 temp_summary_wet %>%
  dplyr::mutate(across(everything(), as.numeric)) %>%
  dplyr::mutate(across(everything(), scale_by_max)) -> temp_summary_wet_percent

# To use the fmsb package, I have to add 2 lines to the dataframe: the max and min of each variable to show on the plot!
temp_summary_wet_percent <- rbind(rep(100,5), rep(0,5), temp_summary_wet_percent)

# Color vector
colors_border=c("orange", "darkblue")
colors_in=c("orange", "darkblue")

# Define colors with transparency using adjustcolor
colors_border <- c(adjustcolor("orange", alpha = 0.9), adjustcolor("darkblue", alpha = 0.9))
colors_in <- c(adjustcolor("orange", alpha = 0.4), adjustcolor("darkblue", alpha = 0.4))

library(fmsb)
# plot with default options:
pdf("radarchart_wetseason.pdf")
radarchart(temp_summary_wet_percent, axistype=1 , 
            #custom polygon
            pcol=colors_border , pfcol=colors_in , plwd=4 , plty=1,
            #custom the grid
            cglcol="grey", cglty=1, axislabcol="grey", caxislabels=seq(0,100,25), cglwd=0.8,
            #custom labels
            vlcex=0.9
)
dev.off()

```

## radar plot for figure

### Site only (2021)
```{r}
temp.summary<- summaryBy(Temperature ~ site, data = alldata_2021,
                         FUN = function(x) { c(max = max(x), min = min(x)) } )
temp.summary$Temp.seasonal <- temp.summary$Temperature.max - temp.summary$Temperature.min

alldata_2021 %>% 
  separate(Datetime_EST, into = c("Date", "Time"), sep = " ") -> alldata_2021_sep

# Daily Range
Daily.range <- summaryBy(Temperature ~ Date + site, data=alldata_2021_sep, FUN=c(max,min,mean,sd))

Daily.range$temp.daily.range <- Daily.range$Temperature.max - Daily.range$Temperature.min

temp.d.range <- summaryBy(temp.daily.range ~ site, data = Daily.range,
                          FUN = function(x) { c(mean = mean(x)) } )
Daily.range %>% 
  filter(Temperature.max > 30.5) %>% 
  group_by(site) %>% 
  dplyr::summarise(d.above.30.5 = n()) -> temp.d.30.5 #they are basically the same

full_join(temp.summary, temp.d.range) %>% 
  full_join(., temp.d.30.5) -> temp_summary


scale_by_max <- function(x) {
  x * 100 / max(x, na.rm = TRUE)
}

colnames(temp_summary) <- c("site", "Max", "Min", "Seasonal", "Daily", "30.5°C")

temp_summary %>% 
  column_to_rownames(var="site") -> temp_summary

 temp_summary %>%
  dplyr::mutate(across(everything(), as.numeric)) %>%
  dplyr::mutate(across(everything(), scale_by_max)) -> temp_summary_percent

# To use the fmsb package, I have to add 2 lines to the dataframe: the max and min of each variable to show on the plot!
temp_summary_percent <- rbind(rep(100,5), rep(0,5), temp_summary_percent)

# Color vector
colors_border=c("orange", "darkblue")
colors_in=c("orange", "darkblue")

# Define colors with transparency using adjustcolor
colors_border <- c(adjustcolor("orange", alpha = 0.9), adjustcolor("darkblue", alpha = 0.9))
colors_in <- c(adjustcolor("orange", alpha = 0.4), adjustcolor("darkblue", alpha = 0.4))

library(fmsb)
# plot with default options:
#pdf("radarchart_alldata_30_5.pdf")
radarchart(temp_summary_percent, axistype=1 , 
            #custom polygon
            pcol=colors_border , pfcol=colors_in , plwd=4 , plty=1,
            #custom the grid
            cglcol="grey", cglty=1, axislabcol="grey", caxislabels=seq(0,100,25), cglwd=0.8,
            #custom labels
            vlcex=0.9
)
```


# MMM

## Calculate MMM from in-situ data
following code: https://github.com/anampc/DHW_Uva/blob/master/A.Temperature_DHW.Rmd lines 107-134

### VK Buoy (Oct 2020 - Dec 2021)
```{r}
vkbuoydata %>% 
  filter(as.Date(Datetime_EST) < "2021-12-01" & as.Date(Datetime_EST) > "2020-10-01") -> vkbuoydata_20202021

# Extract months and years from date
  vkbuoydata_20202021$Month<-month(vkbuoydata_20202021$Datetime_EST)
  vkbuoydata_20202021$Year<-year(vkbuoydata_20202021$Datetime_EST)

# Calculate month-year mean SST
  vkbuoydata.MM_2020_2021<-vkbuoydata_20202021 %>%
    group_by(Month, Year) %>%
    summarize(MM = mean(Temperature, na.rm = TRUE))

# Calculate monthly mean SST
  vkbuoydata.MonthlyClimatology_2020_2021<-vkbuoydata.MM_2020_2021 %>%
    group_by(Month) %>%
    summarize(Clima_M = mean(MM, na.rm = TRUE))
  vkbuoydata.MonthlyClimatology_2020_2021

# Get maximum monthly mean (MMM)
  MMM_VK<-max(vkbuoydata.MonthlyClimatology_2020_2021$Clima_M)
  MMM_VK
  #32.25
```

### Tilt meter (for CCC MMM) (Oct 2020- Dec 2021)
```{r}
cures_frame_tilt_temp %>% 
  filter(as.Date(Datetime_EST) < "2021-12-01") -> curestilt_20202021

# Extract months and years from date
  curestilt_20202021$Month<-month(curestilt_20202021$Datetime_EST)
  curestilt_20202021$Year<-year(curestilt_20202021$Datetime_EST)

# Calculate month-year mean SST
  curestilt.MM_2020_2021<-curestilt_20202021 %>%
    group_by(Month, Year) %>%
    summarize(MM = mean(Temperature, na.rm = TRUE))

# Calculate monthly mean SST
  curestilt.MonthlyClimatology_2020_2021<-curestilt.MM_2020_2021 %>%
    group_by(Month) %>%
    summarize(Clima_M = mean(MM, na.rm = TRUE))
  curestilt.MonthlyClimatology_2020_2021

# Get maximum monthly mean (MMM)
  MMM_CCC_tilt<-max(curestilt.MonthlyClimatology_2020_2021$Clima_M)
  MMM_CCC_tilt
  #30.51
```


### KB HOBO (for nursery MMM) (2020-2021)

manualy filter out the outliers
```{r}
all_KB_data %>% 
  filter(as.Date(Datetime_EST) < "2021-12-01" & as.Date(Datetime_EST) > "2020-10-01") %>% 
  ggplot(., aes(x=Datetime_EST, y=Temperature, color = site)) +
  geom_point() +
  theme_bw() +
  scale_x_datetime(date_labels = "%b %Y",  # Customize the date format
                     date_breaks = "1 month") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

# remove outliers visually determined: june 2021 and august 2021

all_KB_data %>% 
  filter(as.Date(Datetime_EST) < "2021-12-01" & as.Date(Datetime_EST) > "2020-10-01") %>% 
  mutate(z_score = scale(Temperature)) %>% 
  filter(abs(z_score) < 3) -> filtered_KB_data_20202021 

  ggplot(filtered_KB_data_20202021, aes(x=Datetime_EST, y=Temperature, color = site)) +
  geom_point() +
  theme_bw() +
  scale_x_datetime(date_labels = "%b %Y",  # Customize the date format
                     date_breaks = "1 month") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
#this didn't remove that many outliers

filtered_KB_data_20202021 %>% 
  dplyr::select(!z_score) %>% 
  filter(as.Date(Datetime_EST) > "2021-08-10" & as.Date(Datetime_EST) < "2021-08-24") %>% #301 
  filter(Temperature > 27 & Temperature < 31.5) -> august_filtered_KB_data_2021

filtered_KB_data_20202021 %>% 
  filter(!(as.Date(Datetime_EST) > "2021-08-10" & as.Date(Datetime_EST) < "2021-08-24")) %>% 
  full_join(., august_filtered_KB_data_2021) %>% 
  ggplot(., aes(x=Datetime_EST, y=Temperature, color = site)) +
  geom_point() +
  theme_bw() +
  scale_x_datetime(date_labels = "%b %Y",  # Customize the date format
                     date_breaks = "1 month") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
#looks good for the august one

filtered_KB_data_20202021 %>% 
  filter(!(as.Date(Datetime_EST) > "2021-08-10" & as.Date(Datetime_EST) < "2021-08-24")) %>% 
  full_join(., august_filtered_KB_data_2021) -> filtered_KB_data_20202021

filtered_KB_data_20202021 %>% 
  filter(as.Date(Datetime_EST) > "2021-05-15" & as.Date(Datetime_EST) < "2021-06-30") %>% 
  ggplot(., aes(x=Datetime_EST, y=Temperature, color = site)) +
  geom_point() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
#looks like anything below 25ºC during this time should be filtered out

filtered_KB_data_20202021 %>% 
  filter(as.Date(Datetime_EST) > "2021-05-15" & as.Date(Datetime_EST) < "2021-06-30") %>% 
  filter(Temperature > 25)%>% 
  ggplot(., aes(x=Datetime_EST, y=Temperature, color = site)) +
  geom_point() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

filtered_KB_data_20202021 %>% 
  filter(as.Date(Datetime_EST) > "2021-05-15" & as.Date(Datetime_EST) < "2021-06-30") %>% 
  filter(Temperature > 25) -> june_filtered_data_2021

filtered_KB_data_20202021 %>% 
  filter(!(as.Date(Datetime_EST) > "2021-05-15" & as.Date(Datetime_EST) < "2021-06-30")) %>% 
  full_join(., june_filtered_data_2021) -> filtered_KB_data_20202021

ggplot(filtered_KB_data_20202021, aes(x=Datetime_EST, y=Temperature, color = site)) +
  geom_point() +
  theme_bw() +
  scale_x_datetime(date_labels = "%b %Y",  # Customize the date format
                     date_breaks = "1 month") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 
# yay looks good
```


```{r}
filtered_KB_data_20202021 %>% 
  dplyr::select(!c(Light, z_score)) -> filtered_KB_data_20202021
# Extract months and years from date
  filtered_KB_data_20202021$Month<-month(filtered_KB_data_20202021$Datetime_EST)
  filtered_KB_data_20202021$Year<-year(filtered_KB_data_20202021$Datetime_EST)

# Calculate month-year mean SST
  nursery.MM_2020_2021<-filtered_KB_data_20202021 %>%
    group_by(Month, Year) %>%
    summarize(MM = mean(Temperature, na.rm = TRUE))

# Calculate monthly mean SST
  nursery.MonthlyClimatology_2020_2021<-nursery.MM_2020_2021 %>%
    group_by(Month) %>%
    summarize(Clima_M = mean(MM, na.rm = TRUE))
  nursery.MonthlyClimatology_2020_2021

# Get maximum monthly mean (MMM)
  MMM_nursery_HOBO<-max(nursery.MonthlyClimatology_2020_2021$Clima_M)
  MMM_nursery_HOBO
  #30.49
```


## Extract MMM from historical SST (1981-2012)

```{r Extract_OISST_data, cache=TRUE}
 library(raster)
  library(parallel)
library(ncdf4)


  # Read climatology file
  Climatology_MMM <- "raw_data/ct5km_climatology_v3.1.nc" #this only has mean monthly maximum data
  MMM.data <- brick(Climatology_MMM) 
  #MMM.data
  
  print(MMM.data)
  
  # KB Nursery
  lat_KB <- (25.6763)
  lon_KB <- (-80.0987)
  extract.pts_KB <- cbind(lon_KB,lat_KB)
  
  #CCC 
  lat.CCC <- (25.766626)
  lon.CCC <- (-80.144812)
  extract_CCC <- cbind(lon.CCC, lat.CCC)
  
  #MMM <- raster::extract(MMM.data, extract.pts,method="bilinear")
  MMM <- raster::extract(MMM.data, extract.pts_KB,method="simple") # MMM for KB is 29.53
  MMM_CCC <- raster::extract(MMM.data, extract_CCC,method="simple") # MMM for CCC is 29.54
  
  MMM_SST_1981_2012_Nursery = 29.53
  MMM_SST_1981_2012_CCC = 29.54

  #write.csv(MMM, "KB_CRW_MMM_1985-2012.csv", row.names=FALSE)

  #write.csv(MMM_CCC, "CCC_CRW_MMM_1985-2012.csv", row.names=FALSE)
```


## Calculate MMM from 2020-2021 SST CRW data
```{r}
CRW_SST_2020_2021$Month <- month(CRW_SST_2020_2021$Date)
CRW_SST_2020_2021$Year <- year(CRW_SST_2020_2021$Date)

# Calculate month-year mean SST

MM.CRW_SST_2020_2021 <- CRW_SST_2020_2021 %>% 
  group_by(Month, Year, site) %>% 
summarize(MM = mean(Temperature, na.rm = TRUE))

# Calculate monthly mean SST

monthlyclimatology<-MM.CRW_SST_2020_2021 %>% 
  group_by(Month, site) %>%
    summarize(Clima_M = mean(MM, na.rm = TRUE))

monthlyclimatology %>% 
  filter(site == "Nursery") -> monthlyclimatology_nursery

monthlyclimatology %>% 
  filter(site == "CCC") -> monthlyclimatology_CCC

# Get maximum monthly mean (MMM)
  MMM_SST_20202021_nursery <-max(monthlyclimatology_nursery$Clima_M) #30.04
  MMM_SST_20202021_CCC <- max(monthlyclimatology_CCC$Clima_M) #30.03
```


### plot the mean daily temp for in-situ data and 2020-2021 SST data
```{r}
CRW_SST_2020_2021 %>% 
  mutate(site = case_when(site == "Nursery" ~ "20202021_SST_Nursery",
                          site == "CCC" ~ "20202021_SST_CCC")) -> CRW_SST_2020_2021

full_join(filtered_KB_data_20202021, cures_frame_tilt_temp) %>%
  mutate(Date = as.Date(Datetime_EST)) %>% 
  full_join(., CRW_SST_2020_2021) %>% 
  group_by(Date, site) %>% 
  mutate(mean_daily_temp = mean(Temperature)) %>% 
  select(!c(Datetime_EST, Month, Year, Temperature)) %>%
  distinct() %>% 
 filter(Date < "2021-12-01" & Date > "2021-06-20") %>% 
  ggplot(., aes(x=Date, y=mean_daily_temp, color = site)) +
  geom_line() +
  theme_bw() +
  labs(x="Date", y = "Mean Daily Temp (ºC)") +
  scale_color_manual(values = c("CURES_tilt" = "orange", "Nursery" = "darkblue", "20202021_SST_Nursery" = "lightblue", "20202021_SST_CCC" = "aquamarine")) +
  geom_hline(yintercept = 29.54, linetype = "dashed", color = "grey") +
  geom_hline(yintercept = 30.49, linetype = "dashed", color = "darkblue") +
  geom_hline(yintercept = 30.51, linetype = "dashed", color = "orange") +
  geom_hline(yintercept = 30.04, linetype = "dashed", color = "lightblue") +
  annotate("text", x = max(CRW_SST_2020_2021$Date) + 1, y = 29.3, label = "SST 1981-2012 MMM", hjust = 1.1, color = "grey") +
  annotate("text", x = max(CRW_SST_2020_2021$Date) + 1, y = 30.3, label = "Nursery HOBO MMM", hjust = 1.1, color = "darkblue") +
  annotate("text", x = max(CRW_SST_2020_2021$Date) + 1, y = 30.7, label = "CCC Tilt MMM", hjust = 1.1, color = "orange") +
  annotate("text", x = max(CRW_SST_2020_2021$Date) + 2, y = 29.9, label = "SST 2020-2021 MMM", hjust = 1.1, color = "lightblue") 
#ggsave("CURES_nursery_SST_dailytemp_allMMMs.pdf", width=10, height = 7)
```

### plot bleaching thresholds (MMM + 1ºC)
```{r}
full_join(filtered_KB_data_20202021, cures_frame_tilt_temp) %>%
 filter(as.Date(Datetime_EST) < "2021-12-01" & as.Date(Datetime_EST) > "2021-06-20") %>% 
  ggplot(., aes(x=Datetime_EST, y=Temperature, color = site)) +
  geom_line() +
  theme_bw() +
  labs(x="Date", y = "Temp (ºC)") +
  scale_color_manual(values = c("CURES_tilt" = "orange", "Nursery" = "darkblue")) +
  geom_hline(yintercept = 29.54, linetype = "dashed", color = "grey") +
  geom_hline(yintercept = 30.49, linetype = "dashed", color = "darkblue") +
  geom_hline(yintercept = 30.51, linetype = "dashed", color = "orange") +
  geom_hline(yintercept = 30.54, linetype = "dashed", color = "grey") +
  geom_hline(yintercept = 31.49, linetype = "dashed", color = "darkblue") +
  geom_hline(yintercept = 31.51, linetype = "dashed", color = "orange") +
  geom_hline(yintercept = 30.04, linetype = "dashed", color = "lightblue") +
  geom_hline(yintercept = 31.04, linetype = "dashed", color = "lightblue") +
  annotate("text", x = max(filtered_KB_data_20202021$Datetime_EST) + 1, y = 29.3, label = "SST 1981-2012 MMM", hjust = 1.1, color = "grey") +
  annotate("text", x = max(filtered_KB_data_20202021$Datetime_EST) + 1, y = 30.2, label = "Nursery HOBO MMM", hjust = 1.1, color = "darkblue") +
  annotate("text", x = max(filtered_KB_data_20202021$Datetime_EST) + 1, y = 30.7, label = "CCC Tilt MMM", hjust = 1.1, color = "orange") +
    annotate("text", x = max(filtered_KB_data_20202021$Datetime_EST) + 1, y = 30.4, label = "1981-2012 SST bleaching threshold", hjust = 1.1, color = "grey") +
  annotate("text", x = max(filtered_KB_data_20202021$Datetime_EST) + 1, y = 31.3, label = "Nursery bleaching threshold", hjust = 1.1, color = "darkblue") +
  annotate("text", x = max(filtered_KB_data_20202021$Datetime_EST) + 1, y = 31.7, label = "CCC bleaching theshold", hjust = 1.1, color = "orange") +
  annotate("text", x = max(filtered_KB_data_20202021$Datetime_EST) + 2, y = 29.9, label = "SST 2020-2021 MMM", hjust = 1.1, color = "lightblue") +
  annotate("text", x = max(filtered_KB_data_20202021$Datetime_EST) + 2, y = 30.9, label = "SST 2020-2021 bleaching threshold", hjust = 1.1, color = "lightblue") 
ggsave("CURES_nursery_temp_allMMMs_bleachingthresholds.png", width=10, height = 7)
```


### calculate SST DHW

from https://github.com/anampc/DHW_Uva/blob/master/A.Temperature_DHW.Rmd

#### historical (1981-2012) SST
```{r}
#for the DHW rollapplyr function it is critical that the dates are in ascending order and that the sites are separated

#first do nursery
filtered_KB_data_20202021 %>% 
  mutate(site = case_when(site == "Nursery" ~ "Nursery_SST_19812012")) %>% 
  separate(Datetime_EST, into = c("Date", "Time"), sep = " ") %>% 
  arrange(Date) %>% 
  dplyr::group_by(Date) %>% 
  mutate(mean_daily_temp = mean(Temperature)) %>% 
  dplyr::select(!c(Temperature, Time, Month, Year)) %>% 
  distinct() %>% 
  mutate(HotSpot = case_when(site == "Nursery_SST_19812012" ~ (mean_daily_temp - 29.53))) %>% 
  mutate(HotSpot = ifelse(HotSpot >= 0, HotSpot, 0)) %>% 
  mutate(Stress = ifelse(HotSpot >= 1, HotSpot, 0)) %>% 
  mutate(Weeks_Stress = Stress/7) -> Long.data.DHW.nurserySST
  
Long.data.DHW.nurserySST$DHW<-rollapplyr(Long.data.DHW.nurserySST$Weeks_Stress,list(-(83:0)),sum,fill=NA)

ggplot(Long.data.DHW.nurserySST, aes(x=ymd(Date))) + 
    geom_hline(yintercept=8, linetype="dashed")+
    geom_hline(yintercept=4, linetype="dashed")+
    geom_line(aes(y = DHW)) #ok this looks better
  
# now do CCC
curestilt_20202021 %>% 
  mutate(site = case_when(site == "CURES_tilt" ~ "CCC_SST_19812012")) %>% 
  separate(Datetime_EST, into = c("Date", "Time"), sep = " ") %>% 
  arrange(Date) %>% 
  dplyr::group_by(Date) %>% 
  mutate(mean_daily_temp = mean(Temperature)) %>% 
  dplyr::select(!c(Temperature, Time)) %>% 
  distinct() %>% 
  mutate(HotSpot = case_when(site == "CCC_SST_19812012" ~ (mean_daily_temp - 29.54))) %>% 
  mutate(HotSpot = ifelse(HotSpot >= 0, HotSpot, 0)) %>% 
  mutate(Stress = ifelse(HotSpot >= 1, HotSpot, 0)) %>% 
  mutate(Weeks_Stress = Stress/7)  -> Long.data.DHW.CCCSST

Long.data.DHW.CCCSST$DHW<-rollapplyr(Long.data.DHW.CCCSST$Weeks_Stress,list(-(83:0)),sum,fill=NA)

ggplot(Long.data.DHW.CCCSST, aes(x=ymd(Date))) + 
    geom_hline(yintercept=8, linetype="dashed")+
    geom_hline(yintercept=4, linetype="dashed")+
    geom_line(aes(y = DHW)) #ok this looks better


# Plot just DHW SST data
full_join(Long.data.DHW.nurserySST, Long.data.DHW.CCCSST) %>% 
  filter(ymd(Date) >= "2021-01-01") %>% 
ggplot(., aes(x=ymd(Date))) + 
    geom_hline(yintercept=8, linetype="dashed")+
    geom_hline(yintercept=4, linetype="dashed")+
    geom_line(aes(y = DHW, color = site)) +
    ylab("DWH (C-week)  /  Temperature (C)") +
    xlab("Date") +
    theme_classic() +
  scale_color_manual(values = c("CCC_SST_19812012" = "orange", "Nursery_SST_19812012" = "darkblue"))
#ggsave("DHW_linegraph.pdf")

# Highest DHW per year
max(Long.data.DHW.nurserySST$Date) #"2021-11-30"
max(Long.data.DHW.CCCSST$Date) #"2021-11-30"
#this is only the span of january to december 2021
    MaxDHW_SST<-full_join(Long.data.DHW.nurserySST, Long.data.DHW.CCCSST) %>% 
  filter(ymd(Date) >= "2021-01-01") %>% 
          group_by(site) %>%
          summarize(max = max(DHW, na.rm=TRUE))
```

#### 2020-2021 SST
```{r}
#nursery 
filtered_KB_data_20202021 %>% 
  mutate(site = case_when(site == "Nursery" ~ "Nursery_SST_20202021")) %>% 
  separate(Datetime_EST, into = c("Date", "Time"), sep = " ") %>% 
  arrange(Date) %>% 
  dplyr::group_by(Date) %>% 
  mutate(mean_daily_temp = mean(Temperature)) %>% 
  dplyr::select(!c(Temperature, Time, Month, Year)) %>% 
  distinct() %>% 
  mutate(HotSpot = case_when(site == "Nursery_SST_20202021" ~ (mean_daily_temp - MMM_SST_20202021_nursery))) %>% 
  mutate(HotSpot = ifelse(HotSpot >= 0, HotSpot, 0)) %>% 
  mutate(Stress = ifelse(HotSpot >= 1, HotSpot, 0)) %>% 
  mutate(Weeks_Stress = Stress/7) -> Long.data.DHW.nurserySST_2021
  
Long.data.DHW.nurserySST_2021$DHW<-rollapplyr(Long.data.DHW.nurserySST_2021$Weeks_Stress,list(-(83:0)),sum,fill=NA)

ggplot(Long.data.DHW.nurserySST_2021, aes(x=ymd(Date))) + 
    geom_hline(yintercept=8, linetype="dashed")+
    geom_hline(yintercept=4, linetype="dashed")+
    geom_line(aes(y = DHW)) #ok this looks better

max(Long.data.DHW.nurserySST_2021$DHW, na.rm = TRUE)

# now do CCC
curestilt_20202021 %>% 
  mutate(site = case_when(site == "CURES_tilt" ~ "CCC_SST_20202021")) %>%
  separate(Datetime_EST, into = c("Date", "Time"), sep = " ") %>% 
  arrange(Date) %>% 
  dplyr::group_by(Date) %>% 
  mutate(mean_daily_temp = mean(Temperature)) %>% 
  dplyr::select(!c(Temperature, Time)) %>% 
  distinct() %>% 
  mutate(HotSpot = case_when(site == "CCC_SST_20202021" ~ (mean_daily_temp - MMM_SST_20202021_CCC))) %>% 
  mutate(HotSpot = ifelse(HotSpot >= 0, HotSpot, 0)) %>% 
  mutate(Stress = ifelse(HotSpot >= 1, HotSpot, 0)) %>% 
  mutate(Weeks_Stress = Stress/7)  -> Long.data.DHW.CCCSST_2021

Long.data.DHW.CCCSST_2021$DHW<-rollapplyr(Long.data.DHW.CCCSST_2021$Weeks_Stress,list(-(83:0)),sum,fill=NA)

ggplot(Long.data.DHW.CCCSST_2021, aes(x=ymd(Date))) + 
    geom_hline(yintercept=8, linetype="dashed")+
    geom_hline(yintercept=4, linetype="dashed")+
    geom_line(aes(y = DHW)) #ok this looks better

max(Long.data.DHW.CCCSST_2021$DHW, na.rm = TRUE)
```


### calculate in-situ DHW
```{r}
#first do nursery
filtered_KB_data_20202021 %>% 
  mutate(site = case_when(site == "Nursery" ~ "Nursery_insitu")) %>% 
  separate(Datetime_EST, into = c("Date", "Time"), sep = " ") %>% 
  arrange(Date) %>% 
  dplyr::group_by(Date) %>% 
  mutate(mean_daily_temp = mean(Temperature)) %>% 
  dplyr::select(!c(Temperature, Time, Month, Year)) %>% 
  distinct() %>% 
  mutate(HotSpot = case_when(site == "Nursery_insitu" ~ (mean_daily_temp - MMM_nursery_HOBO))) %>% 
  mutate(HotSpot = ifelse(HotSpot >= 0, HotSpot, 0)) %>% 
  mutate(Stress = ifelse(HotSpot >= 1, HotSpot, 0)) %>% 
  mutate(Weeks_Stress = Stress/7) -> Long.data.DHW.nurseryinsitu
  
Long.data.DHW.nurseryinsitu$DHW<-rollapplyr(Long.data.DHW.nurseryinsitu$Weeks_Stress,list(-(83:0)),sum,fill=NA)

max(Long.data.DHW.nurseryinsitu$DHW,  na.rm = TRUE) #0

ggplot(Long.data.DHW.nurseryinsitu, aes(x=ymd(Date))) + 
    geom_hline(yintercept=8, linetype="dashed")+
    geom_hline(yintercept=4, linetype="dashed")+
    geom_line(aes(y = DHW)) #zero

# now do CCC
curestilt_20202021 %>% 
  mutate(site = case_when(site == "CURES_tilt" ~ "CCC_insitu")) %>% 
  separate(Datetime_EST, into = c("Date", "Time"), sep = " ") %>% 
  arrange(Date) %>% 
  dplyr::group_by(Date) %>% 
  mutate(mean_daily_temp = mean(Temperature)) %>% 
  dplyr::select(!c(Temperature, Time)) %>% 
  distinct() %>% 
  mutate(HotSpot = case_when(site == "CCC_insitu" ~ (mean_daily_temp - MMM_CCC_tilt))) %>% 
  mutate(HotSpot = ifelse(HotSpot >= 0, HotSpot, 0)) %>% 
  mutate(Stress = ifelse(HotSpot >= 1, HotSpot, 0)) %>% 
  mutate(Weeks_Stress = Stress/7)  -> Long.data.DHW.CCCinsitu

Long.data.DHW.CCCinsitu$DHW<-rollapplyr(Long.data.DHW.CCCinsitu$Weeks_Stress,list(-(83:0)),sum,fill=NA)

ggplot(Long.data.DHW.CCCinsitu, aes(x=ymd(Date))) + 
    geom_hline(yintercept=8, linetype="dashed")+
    geom_hline(yintercept=4, linetype="dashed")+
    geom_line(aes(y = DHW)) #the tiniest blip

max(Long.data.DHW.CCCinsitu$DHW, na.rm = TRUE)
```


### plot all DHW together
```{r}
rbind(Long.data.DHW.CCCinsitu, Long.data.DHW.nurseryinsitu) %>% 
  full_join(., Long.data.DHW.CCCSST) %>% 
  rbind(., Long.data.DHW.CCCSST_2021, Long.data.DHW.nurserySST, Long.data.DHW.nurserySST_2021) %>% 
 mutate(site = factor(site, levels = c("CCC_SST_19812012", "Nursery_SST_19812012", "CCC_SST_20202021", "CCC_insitu", "Nursery_SST_20202021", "Nursery_insitu"))) %>% 
  ggplot(., aes(x=ymd(Date), y=DHW, color = site)) + 
  geom_line() + 
    geom_hline(yintercept=8, linetype="dashed")+
    geom_hline(yintercept=4, linetype="dashed") +
  theme_bw()
#ggsave("all_DHWs.pdf", width = 10, height = 7)
```

```{r}
rbind(Long.data.DHW.CCCinsitu, Long.data.DHW.nurseryinsitu) %>% 
  full_join(., Long.data.DHW.CCCSST) %>% 
  rbind(., Long.data.DHW.CCCSST_2021, Long.data.DHW.nurserySST, Long.data.DHW.nurserySST_2021) %>% 
 mutate(site = factor(site, levels = c("CCC_SST_19812012", "Nursery_SST_19812012", "CCC_SST_20202021", "CCC_insitu", "Nursery_SST_20202021", "Nursery_insitu"))) %>% 
  group_by(site) %>% 
  summarise(maxDHW = max(DHW, na.rm = TRUE)) -> max_DHW_alltypes
```



from this point on, use in-situ data + daily temps from 2020-2021 SST + both MMMs


## radar plot

June 20, 2021 -- Dec 1, 2021
```{r}
CRW_SST_2020_2021 %>% 
  mutate(site = case_when(site == "Nursery" ~ "20202021_SST_Nursery",
                          site == "CCC" ~ "20202021_SST_CCC")) -> CRW_SST_2020_2021

full_join(filtered_KB_data_20202021, cures_frame_tilt_temp) %>%
  mutate(Date = as.Date(Datetime_EST)) %>% 
  full_join(., CRW_SST_2020_2021) %>% 
  group_by(Date, site) %>% 
  mutate(mean_daily_temp = mean(Temperature)) %>% 
  select(!c(Datetime_EST, Month, Year, Temperature)) %>%
  distinct() %>% 
 filter(Date < "2021-12-01" & Date > "2021-06-20") %>% 
  mutate(Season = case_when(Date <= "2021-10-15" ~ "Wet",
                            Date >= "2021-10-16" ~ "Dry")) -> alldata_2021
```

### Site, DHW
```{r}
temp.summary<- summaryBy(mean_daily_temp ~ site, data = alldata_2021,
                         FUN = function(x) { c(max = max(x), min = min(x)) } )

temp.summary$Temp.seasonal <- temp.summary$mean_daily_temp.max - temp.summary$mean_daily_temp.min

#bind all DHWs
max_DHW_alltypes %>% 
  filter(site != "CCC_SST_19812012" & site != "Nursery_SST_19812012") %>% 
cbind(temp.summary, .)  -> temp_DHW_summary

temp_DHW_summary %>% 
  select(!c(5)) -> temp_DHW_summary

write_csv(temp_DHW_summary, "temp_DHW_summary.csv")
```


```{r}
scale_by_max <- function(x) {
  x * 100 / max(x, na.rm = TRUE)
}

temp_DHW_summary %>% 
  column_to_rownames(var="site") -> temp_DHW_summary

colnames(temp_DHW_summary) <- c("Max", "Min", "Seasonal", "DHW")

 temp_DHW_summary %>%
  dplyr::mutate(across(everything(), as.numeric)) %>%
  dplyr::mutate(across(everything(), scale_by_max)) -> temp_summary_percent

# To use the fmsb package, I have to add 2 lines to the dataframe: the max and min of each variable to show on the plot!
temp_summary_percent <- rbind(rep(100,5), rep(0,5), temp_summary_percent)

# Color vector
colors_border=c("yellow", "lightblue", "orange", "darkblue")
colors_in=c("yellow", "lightblue","orange", "darkblue")

# Define colors with transparency using adjustcolor
colors_border <- c(adjustcolor("yellow", alpha = 0.9), adjustcolor("lightblue", alpha = 0.9), adjustcolor("orange", alpha = 0.9), adjustcolor("darkblue", alpha = 0.9))
colors_in <- c(adjustcolor("yellow", alpha = 0.4), adjustcolor("lightblue", alpha = 0.4), adjustcolor("orange", alpha = 0.4), adjustcolor("darkblue", alpha = 0.4))

library(fmsb)
# plot with default options:
pdf("radarchart_SST_initu.pdf")
radarchart(temp_summary_percent, axistype=1 , 
            #custom polygon
            pcol=colors_border , pfcol=colors_in , plwd=4 , plty=1,
            #custom the grid
            cglcol="grey", cglty=1, axislabcol="grey", caxislabels=seq(0,100,25), cglwd=0.8,
            #custom labels
            vlcex=0.9
)
dev.off()

```

## radar plot for figure

### Site only (2021)
```{r}
temp.summary<- summaryBy(Temperature ~ site, data = alldata_2021,
                         FUN = function(x) { c(max = max(x), min = min(x)) } )
temp.summary$Temp.seasonal <- temp.summary$Temperature.max - temp.summary$Temperature.min

alldata_2021 %>% 
  separate(Datetime_EST, into = c("Date", "Time"), sep = " ") -> alldata_2021_sep

# Daily Range
Daily.range <- summaryBy(Temperature ~ Date + site, data=alldata_2021_sep, FUN=c(max,min,mean,sd))

Daily.range$temp.daily.range <- Daily.range$Temperature.max - Daily.range$Temperature.min

temp.d.range <- summaryBy(temp.daily.range ~ site, data = Daily.range,
                          FUN = function(x) { c(mean = mean(x)) } )
Daily.range %>% 
  filter(Temperature.max > 30.5) %>% 
  group_by(site) %>% 
  dplyr::summarise(d.above.30.5 = n()) -> temp.d.30.5 #they are basically the same

full_join(temp.summary, temp.d.range) %>% 
  full_join(., temp.d.30.5) -> temp_summary


scale_by_max <- function(x) {
  x * 100 / max(x, na.rm = TRUE)
}

colnames(temp_summary) <- c("site", "Max", "Min", "Seasonal", "Daily", "30.5°C")

temp_summary %>% 
  column_to_rownames(var="site") -> temp_summary

 temp_summary %>%
  dplyr::mutate(across(everything(), as.numeric)) %>%
  dplyr::mutate(across(everything(), scale_by_max)) -> temp_summary_percent

# To use the fmsb package, I have to add 2 lines to the dataframe: the max and min of each variable to show on the plot!
temp_summary_percent <- rbind(rep(100,5), rep(0,5), temp_summary_percent)

# Color vector
colors_border=c("orange", "darkblue")
colors_in=c("orange", "darkblue")

# Define colors with transparency using adjustcolor
colors_border <- c(adjustcolor("orange", alpha = 0.9), adjustcolor("darkblue", alpha = 0.9))
colors_in <- c(adjustcolor("orange", alpha = 0.4), adjustcolor("darkblue", alpha = 0.4))

library(fmsb)
# plot with default options:
#pdf("radarchart_alldata_30_5.pdf")
radarchart(temp_summary_percent, axistype=1 , 
            #custom polygon
            pcol=colors_border , pfcol=colors_in , plwd=4 , plty=1,
            #custom the grid
            cglcol="grey", cglty=1, axislabcol="grey", caxislabels=seq(0,100,25), cglwd=0.8,
            #custom labels
            vlcex=0.9
)
```




## make new radar plot

```{r}
cbind(temp_summary, MaxDHW) %>% 
  dplyr::select(!c(`year(Date)`,site)) -> temp_DHW_summary

#write_csv(temp_DHW_summary, "temp_DHW_summary.csv")


scale_by_max <- function(x) {
  x * 100 / max(x, na.rm = TRUE)
}


 temp_DHW_summary %>%
  dplyr::mutate(across(everything(), as.numeric)) %>%
  dplyr::mutate(across(everything(), scale_by_max)) -> temp_DHW_summary_percent

# To use the fmsb package, I have to add 2 lines to the dataframe: the max and min of each variable to show on the plot!
temp_DHW_summary_percent <- rbind(rep(100,5), rep(0,5), temp_DHW_summary_percent)

# Color vector
colors_border=c("orange", "darkblue")
colors_in=c("orange", "darkblue")

# Define colors with transparency using adjustcolor
colors_border <- c(adjustcolor("orange", alpha = 0.9), adjustcolor("darkblue", alpha = 0.9))
colors_in <- c(adjustcolor("orange", alpha = 0.4), adjustcolor("darkblue", alpha = 0.4))

library(fmsb)
# plot with default options:
pdf("radarchart_withDHW.pdf")
radarchart(temp_DHW_summary_percent, axistype=1 , 
            #custom polygon
            pcol=colors_border , pfcol=colors_in , plwd=4 , plty=1,
            #custom the grid
            cglcol="grey", cglty=1, axislabcol="grey", caxislabels=seq(0,100,25), cglwd=0.8,
            #custom labels
            vlcex=0.9
)
```



# Stats

```{r}
library(rstatix)
# Ensure 'site' and 'season' are factors
alldata_2021$site <- as.factor(alldata_2021$site)
alldata_2021$Season <- as.factor(alldata_2021$Season)

#this is just during the experimental period: jun-dec 2021

treat_model <- lm(Temperature ~ site*Season, data = alldata_2021)
treat_model_metrics <- augment(treat_model)
plot(treat_model) #sufficiently normal

# Run the two-way ANOVA
result <- aov(Temperature ~ site * Season, data = alldata_2021)


# Display the summary of the ANOVA
summary(result)

capture.output(summary(result), file = "temp_anova.csv")

TukeyHSD(aov(Temperature ~ site * Season, data = alldata_2021))
capture.output(TukeyHSD(aov(Temperature ~ site * Season, data = alldata_2021)), file = "temp_anova_tukey.csv")
```

