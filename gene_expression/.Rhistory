panel.grid.minor = element_blank()
)
ggsave("4_WGCNA/GO_dotplot_sig_modules.pdf", width = 13, height = 8)
# Create dot plot
top_terms %>%
filter(Ontology!="CC") %>%
ggplot(., aes(x = GeneRatio, y = fct_reorder(Term, GeneRatio))) +
geom_point(aes(size = Significant, color = NegLog10P)) +
scale_color_gradient(low = "blue", high = "red",
name = "-log10(P-value)") +
scale_size_continuous(name = "Gene Count", range = c(1, 8)) +
facet_grid(Ontology ~ module, scales = "free_y", space = "free_y") +
labs(x = "Gene Ratio",
y = "") +
theme_bw() +
theme(
strip.text = element_text(size = 12, face = "bold"),
axis.text.y = element_text(size = 12),
panel.grid.major.y = element_line(color = "grey90"),
panel.grid.minor = element_blank(),
legend.position = "top"
)
ggsave("4_WGCNA/GO_dotplot_sig_modules.pdf", width = 13, height = 8)
# Create dot plot
top_terms %>%
filter(Ontology!="CC") %>%
ggplot(., aes(x = GeneRatio, y = fct_reorder(Term, GeneRatio))) +
geom_point(aes(size = Significant, color = NegLog10P)) +
scale_color_gradient(low = "blue", high = "red",
name = "-log10(P-value)") +
scale_size_continuous(name = "Gene Count", range = c(1, 8)) +
facet_grid(Ontology ~ module, scales = "free_y", space = "free_y") +
labs(x = "Gene Ratio",
y = "") +
theme_bw() +
theme(
strip.text = element_text(size = 14, face = "bold"),
axis.text.y = element_text(size = 14),
panel.grid.major.y = element_line(color = "grey90"),
panel.grid.minor = element_blank(),
legend.position = "top"
)
ggsave("4_WGCNA/GO_dotplot_sig_modules.pdf", width = 13, height = 8)
sig_wgcna_modules %>%
drop_na() %>%
dplyr::select(GO_slim_term:Ontology) %>%
distinct()
sig_wgcna_modules %>%
drop_na() %>%
dplyr::select(GO_slim_term:Ontology) %>%
distinct() %>%
write_csv("4_WGCNA/GO_slim_terms_sig_modules.csv")
merged_results
all_slim_results
GO_results
GO_results
GO_results %>%
filter(module == "darkmagenta" | module == "mediumpurple3") %>%
group_by(Ontology, module) %>%
summarise(total_genes = sum(Significant))
library(tidyverse)
library(dplyr)
library(ggplot2)
library(reshape2)
library(topGO)
library(plyr)
library(tidyr)
library(scales)
library(stringr)
library(GSEABase)
library(rrvgo)
load("Rdata_files/initial_fullddsdesigncountsVsdcounts.RData")
load("Rdata_files/realModels_Acer.RData")
load("Rdata_files/vsd.RData")
load("Rdata_files/pvals.RData")
geneID2GO <- read.delim("~/OneDrive - University of Miami/PhD/NOAA AOML Coral Program/chapter2_UrbanCorals/Acropora_iso2go.tab", header = FALSE, stringsAsFactors = FALSE)
colnames(geneID2GO) <- c("gene", "GO")
length(geneID2GO) #7995
# Split on semicolon
geneID2GO <- setNames(strsplit(geneID2GO$GO, ";"), geneID2GO$gene)
# Background = all genes from the mapping
allgenes <- names(geneID2GO)
Acer_host_DEGs <- read_csv("results/Acer_host_LFCshrink_annotDGEs_padj05.csv")
Acer_host_DEGs %>%
dplyr::select(gene) -> Acer_host_DEGs
## Background universe
allgenes <- rownames(dds)  # or equivalent
## DEG list
DEG_genes <- unique(Acer_host_DEGs$gene)
## Build topGO geneList
geneList <- as.integer(allgenes %in% DEG_genes)
names(geneList) <- allgenes
str(geneList)
sum(names(geneList) %in% names(geneID2GO)) #7417
## Build topGOdata objects
GOdata_BP <- new("topGOdata",
ontology = "BP",
allGenes = geneList,
geneSelectionFun = function(x) x == 1,
annot = annFUN.gene2GO,
gene2GO = geneID2GO,
nodeSize = 5)
slim_results<-read_csv("GOslim_enrichment_Acer_host.csv")
slim_results<-read_csv("5_GO/GOslim_enrichment_Acer_host.csv")
slim_results
slim_results %>%
dplyr::rename(ParentTermID = SlimID, ParentTermDescription = Term) %>%
dplyr::select(!EnrichedGOTerms) %>%
separate_rows(EnrichedGOIDs, sep = ", ") -> GO_slim_edited
GO_slim_edited
# Merge GO_results with GO_slim to add GOTerms column
GO_slim_edited %>%
full_join(GO_results, by = c("EnrichedGOIDs" = "GO.ID", "Ontology")) %>%
write_csv("GO_enrichment_Acer_host_allterms_withGOslim.csv")
GO_results <- read_csv("5_GO/GO_enrichment_Acer_host.csv")
GO_results
# Merge GO_results with GO_slim to add GOTerms column
GO_slim_edited %>%
full_join(GO_results, by = c("EnrichedGOIDs" = "GO.ID")) %>%
write_csv("GO_enrichment_Acer_host_allterms_withGOslim.csv")
GO_slim_edited %>%
full_join(GO_results, by = c("EnrichedGOIDs" = "GO.ID"))
# Merge GO_results with GO_slim to add GOTerms column
GO_slim_edited %>%
full_join(GO_results, by = c("EnrichedGOIDs" = "GO.ID")) -> GO_terms_Acer_host
GO_terms_Acer_host
GO_terms_Acer_host %>%
drop_na() %>%
dplyr::select(ParentTermID:Ontology) %>%
distinct() %>%
ggplot(., aes(x = fct_reorder(ParentTermID, Count), y = Count, fill = Ontology)) +
geom_bar(stat = "identity") +
scale_fill_manual(values = c("BP" = "#8DD3C7",
"MF" = "#FFFFB3",
"CC" = "#BEBADA")) +
labs(x = "Parent GO Term",
y = "Count",
fill = "Ontology") +
theme_bw() +
theme(
axis.text.y = element_text(size = 9),
legend.position = "bottom"
) +
facet_wrap(~module, scales = "free") +
coord_flip()
GO_terms_Acer_host %>%
drop_na() %>%
dplyr::select(ParentTermID:Ontology) %>%
distinct() %>%
ggplot(., aes(x = fct_reorder(ParentTermID, Count), y = Count, fill = Ontology)) +
geom_bar(stat = "identity") +
scale_fill_manual(values = c("BP" = "#8DD3C7",
"MF" = "#FFFFB3",
"CC" = "#BEBADA")) +
labs(x = "Parent GO Term",
y = "Count",
fill = "Ontology") +
theme_bw() +
theme(
axis.text.y = element_text(size = 9),
legend.position = "bottom"
) +
coord_flip()
GO_terms_Acer_host %>%
drop_na()
GO_terms_Acer_host %>%
drop_na() %>%
dplyr::select(ParentTermDescription:Ontology) %>%
distinct() %>%
ggplot(., aes(x = fct_reorder(ParentTermDescription, Count), y = Count, fill = Ontology)) +
geom_bar(stat = "identity") +
scale_fill_manual(values = c("BP" = "#8DD3C7",
"MF" = "#FFFFB3",
"CC" = "#BEBADA")) +
labs(x = "Parent GO Term",
y = "Count",
fill = "Ontology") +
theme_bw() +
theme(
axis.text.y = element_text(size = 9),
legend.position = "bottom"
) +
coord_flip()
GO_terms_Acer_host %>%
drop_na() %>%
dplyr::select(ParentTermID:Ontology) %>%
distinct() %>%
ggplot(., aes(x = fct_reorder(ParentTermDescription, Count), y = Count, fill = Ontology)) +
geom_bar(stat = "identity") +
scale_fill_manual(values = c("BP" = "#8DD3C7",
"MF" = "#FFFFB3",
"CC" = "#BEBADA")) +
labs(x = "Parent GO Term",
y = "Count",
fill = "Ontology") +
theme_bw() +
theme(
axis.text.y = element_text(size = 9),
legend.position = "bottom"
) +
coord_flip()
GO_terms_Acer_host %>%
drop_na() %>%
dplyr::select(ParentTermID:Ontology) %>%
distinct()
GO_terms_Acer_host %>%
drop_na() %>%
dplyr::select(ParentTermID:Ontology) %>%
distinct() %>%
write_csv("GO_enrichment_Acer_host_allterms_withGOslim_distinct.csv")
# Prepare data: select top terms per ontology
top_terms <- GO_results %>%
group_by(Ontology) %>%
arrange(weightFisher) %>%
slice_head(n = 10) %>%  # Top 10 per ontology
ungroup() %>%
mutate(
GeneRatio = Significant / Annotated,  # Calculate gene ratio
NegLog10P = -log10(weightFisher),
Term = fct_reorder(Term, NegLog10P)  # Order by significance
)
GO_results
# Prepare data: select top terms per ontology
top_terms <- GO_results %>%
group_by(Class) %>%
arrange(weightFisher) %>%
slice_head(n = 10) %>%  # Top 10 per ontology
ungroup() %>%
mutate(
GeneRatio = Significant / Annotated,  # Calculate gene ratio
NegLog10P = -log10(weightFisher),
Term = fct_reorder(Term, NegLog10P)  # Order by significance
)
# Create dot plot
top_terms %>%
ggplot(., aes(x = GeneRatio, y = fct_reorder(Term, GeneRatio))) +
geom_point(aes(size = Significant, color = NegLog10P)) +
scale_color_gradient(low = "blue", high = "red",
name = "-log10(P-value)") +
scale_size_continuous(name = "Gene Count", range = c(1, 8)) +
facet_grid(Class ~ ., scales = "free_y", space = "free_y") +
labs(x = "Gene Ratio",
y = "") +
theme_bw() +
theme(
strip.text = element_text(size = 14, face = "bold"),
axis.text.y = element_text(size = 14),
panel.grid.major.y = element_line(color = "grey90"),
panel.grid.minor = element_blank(),
legend.position = "top"
)
# Create dot plot
top_terms %>%
mutate(Ontology = case_when(
Class == "Biological_Process" ~ "BP",
Class == "Molecular_Function" ~ "MF",
Class == "Cellular_Component" ~ "CC"
)) %>%
ggplot(., aes(x = GeneRatio, y = fct_reorder(Term, GeneRatio))) +
geom_point(aes(size = Significant, color = NegLog10P)) +
scale_color_gradient(low = "blue", high = "red",
name = "-log10(P-value)") +
scale_size_continuous(name = "Gene Count", range = c(1, 8)) +
facet_grid(Ontology ~ ., scales = "free_y", space = "free_y") +
labs(x = "Gene Ratio",
y = "") +
theme_bw() +
theme(
strip.text = element_text(size = 14, face = "bold"),
axis.text.y = element_text(size = 14),
panel.grid.major.y = element_line(color = "grey90"),
panel.grid.minor = element_blank(),
legend.position = "top"
)
ggsave("figures/GO_dotplot_Acer_host_DEGs.png", width = 10, height = 8)
ggsave("GO_dotplot_Acer_host_DEGs.png", width = 10, height = 8)
geneID2GO <- read.delim("~/OneDrive - University of Miami/PhD/NOAA AOML Coral Program/Omics/Symbiodinium/Symbiodinium_iso2go.tab", header = FALSE, stringsAsFactors = FALSE)
colnames(geneID2GO) <- c("gene", "GO")
length(geneID2GO) #7995
geneID2GO
length(geneID2GO) #7995
geneID2GO
nrows(geneID2GO) #7995
str(geneID2GO)
# Split on semicolon
geneID2GO <- setNames(strsplit(geneID2GO$GO, ";"), geneID2GO$gene)
geneID2GO
# Background = all genes from the mapping
allgenes <- names(geneID2GO)
sym_DEGs <- read_csv("results/Symbiont_LFCshrink_annotDGEs_padj05.csv")
sym_DEGs %>%
dplyr::select(gene) -> sym_DEGs
sym_DEGs
#read in counts
counts = read.delim("results/counts.txt")
#select only Acropora genes, remove Symbiodinium
Sym_counts <- counts %>% filter(!grepl("^Acropora_[0-9]+$", X))
column_to_rownames(Sym_counts, var ="X") -> Sym_counts
Sym_counts %>%
rename_with(~sub("^X(.+)_trimmed$", "Acer_\\1", .)) %>%
select(!X.1) -> Sym_counts
counts = read.delim("results/counts.txt")
#select only Acropora genes, remove Symbiodinium
Sym_counts <- counts %>% filter(!grepl("^Acropora_[0-9]+$", X))
column_to_rownames(Sym_counts, var ="X") -> Sym_counts
Sym_counts %>%
rename_with(~sub("^X(.+)_trimmed$", "Acer_\\1", .)) %>%
select(!X.1) -> Sym_counts
#read in counts
counts = read.delim("results/counts.txt")
#select only Acropora genes, remove Symbiodinium
Sym_counts <- counts %>% filter(!grepl("^Acropora_[0-9]+$", X))
column_to_rownames(Sym_counts, var ="X") -> Sym_counts
Sym_counts %>%
rename_with(~sub("^X(.+)_trimmed$", "Acer_\\1", .)) %>%
select(!X.1) -> Sym_counts
Sym_counts %>%
rename_with(~sub("^X(.+)_trimmed$", "Acer_\\1", .)) %>%
dplyr::select(!X.1) -> Sym_counts
# how many genes we have total?
nrow(Sym_counts) #35, 066
ncol(Sym_counts) #20 samples
Sym_counts %>%
select(!c("Acer_1087", "Acer_1088", "Acer_1096", "Acer_2264", "Acer_2383")) -> Sym_counts
nrow(Sym_counts) #35, 066
Sym_counts %>%
dplyr::select(!c("Acer_1087", "Acer_1088", "Acer_1096", "Acer_2264", "Acer_2383")) -> Sym_counts
nrow(Sym_counts) #35, 066
ncol(Sym_counts) #15 samples
# filtering out low-count genes
keep_sym <- rowSums(Sym_counts) >= 10 # you don't want to do too much pre-filtering because DESeq2 needs low-count genes for dispersion estimates
countData_sym <- Sym_counts[keep_sym,]
nrow(countData_sym) #31,202
ncol(countData_sym) #15
# importing a design .csv file
design = readxl::read_xlsx("sample_metadata.xlsx")
design %>%
filter(!Sample_ID %in% c("1087", "1088", "1096", "2264", "2383")) -> design
design %>%
mutate(Sample_ID = paste("Acer_", Sample_ID, sep = "")) -> design
column_to_rownames(design, var="Sample_ID") -> design
design$Genotype <- as.factor(design$Genotype)
design$Genotype <- factor(gsub("-", "_", design$Genotype)) #DESeq2 does not like hyphens in factor names
design$Genotype <- factor(gsub("'", "", design$Genotype)) #DESeq2 does not like hyphens in factor names
design$Genotype <- factor(gsub(" ", "", design$Genotype)) #DESeq2 does not like hyphens in factor names
design$Location <- as.factor(design$Location)
str(design) #default is alphabetical order, so CCC is the "baseline"
design$Location <- factor(design$Location, levels = c("nursery","CCC")) #make the contrast so nursery is the baseline
str(design)
#check that they match each other
colnames(countData_sym)
rownames(design)
# if there were outliers:
outs=c(6,8) #these numbers were taken from the index.html report from arrayQualityMetrics Figure 2 "Outlier detection"
countData=countData_sym[,-outs]
design=design[-outs,]
# remaking model with outliers removed from dataset
dds = DESeqDataSetFromMatrix(countData=countData, colData=design, design=~ Genotype + Location)
library(DESeq2)
# remaking model with outliers removed from dataset
dds = DESeqDataSetFromMatrix(countData=countData, colData=design, design=~ Genotype + Location)
# takes the sample IDs and factor levels from the design to create new column names for the dataframe
snames=paste(colnames(countData),design[,2], design[,3],sep="_")
snames #i.e.
# renames the column names
colnames(vsd)=snames
dds=DESeq(dds, parallel=TRUE)
## Background universe
allgenes <- rownames(dds)  # or equivalent
## DEG list
DEG_genes <- unique(sym_DEGs$gene)
## Build topGO geneList
geneList <- as.integer(allgenes %in% DEG_genes)
names(geneList) <- allgenes
str(geneList)
sum(names(geneList) %in% names(geneID2GO)) #7417
## Build topGOdata objects
GOdata_BP <- new("topGOdata",
ontology = "BP",
allGenes = geneList,
geneSelectionFun = function(x) x == 1,
annot = annFUN.gene2GO,
gene2GO = geneID2GO,
nodeSize = 5)
GOdata_CC <- new("topGOdata",
ontology = "CC",
allGenes = geneList,
geneSelectionFun = function(x) x == 1,
annot = annFUN.gene2GO,
gene2GO = geneID2GO,
nodeSize = 5)
GOdata_MF <- new("topGOdata",
ontology = "MF",
allGenes = geneList,
geneSelectionFun = function(x) x == 1,
annot = annFUN.gene2GO,
gene2GO = geneID2GO,
nodeSize = 5)
resultTopGO.BP <- runTest(GOdata_BP,
algorithm = "weight01",
statistic = "fisher")
resultTopGO.CC <- runTest(GOdata_CC,
algorithm = "weight01",
statistic = "fisher")
resultTopGO.MF <- runTest(GOdata_MF,
algorithm = "weight01",
statistic = "fisher")
allBPGO <- genesInTerm(GOdata_BP)
allCCGO <- genesInTerm(GOdata_CC)
allMFGO <- genesInTerm(GOdata_MF)
BP_ANNOTATION <- lapply(allBPGO, function(x) x[x %in% DEG_genes])
CC_ANNOTATION <- lapply(allCCGO, function(x) x[x %in% DEG_genes])
MF_ANNOTATION <- lapply(allMFGO, function(x) x[x %in% DEG_genes])
BP_Res <- GenTable(GOdata_BP, weightFisher = resultTopGO.BP, topNodes = length(allBPGO), numChar = 1000)
BP_Res$Class <- "Biological_Process"
BP_Res$GeneList <- vapply(BP_Res$GO.ID, function(go) {
str_c(BP_ANNOTATION[[go]], collapse = ",")
}, character(1))
CC_Res <- GenTable(GOdata_CC, weightFisher = resultTopGO.CC, topNodes = length(allCCGO), numChar = 1000)
CC_Res$Class <- "Cellular_Component"
CC_Res$GeneList <- vapply(CC_Res$GO.ID, function(go) {
str_c(CC_ANNOTATION[[go]], collapse = ",")
}, character(1))
MF_Res <- GenTable(GOdata_MF, weightFisher = resultTopGO.MF, topNodes = length(allMFGO), numChar = 1000)
MF_Res$Class <- "Molecular_Function"
MF_Res$GeneList <- vapply(MF_Res$GO.ID, function(go) {
str_c(MF_ANNOTATION[[go]], collapse = ",")
}, character(1))
GO_results <- bind_rows(MF_Res, CC_Res, BP_Res)
GO_results$weightFisher <- as.numeric(GO_results$weightFisher)
GO_results <- GO_results[GO_results$weightFisher < 0.01, ]
str(GO_results)
GO_results
# Create dot plot
top_terms %>%
mutate(Ontology = case_when(
Class == "Biological_Process" ~ "BP",
Class == "Molecular_Function" ~ "MF",
Class == "Cellular_Component" ~ "CC"
)) %>%
ggplot(., aes(x = GeneRatio, y = fct_reorder(Term, GeneRatio))) +
geom_point(aes(size = Significant, color = NegLog10P)) +
scale_color_gradient(low = "blue", high = "red",
name = "-log10(P-value)") +
scale_size_continuous(name = "Gene Count", range = c(1, 8)) +
facet_grid(Ontology ~ ., scales = "free_y", space = "free_y") +
labs(x = "Gene Ratio",
y = "") +
theme_bw() +
theme(
strip.text = element_text(size = 14, face = "bold"),
axis.text.y = element_text(size = 14),
panel.grid.major.y = element_line(color = "grey90"),
panel.grid.minor = element_blank(),
legend.position = "top"
)
ggsave("GO_dotplot_Acer_host_DEGs.pdf", width = 10, height = 8)
GO_results %>%
summarise(total_genes = sum(Significant))
GO_results
GO_results <- read_csv("5_GO/GO_enrichment_Acer_host.csv")
GO_results %>%
summarise(genes = sum(Significant))
GO_results
GO_results %>%
summarise(genes = sum(Significant))
GO_results %>%
group_by(Class)
GO_results %>%
group_by(Class) %>%
summarise(genes = sum(Significant))
GO_results %>%
group_by(Ontology) %>%
summarise(genes = sum(Significant))
GO_results
GO_results %>%
group_by(Class) %>%
summarise(genes = sum(Significant))
GO_results %>%
mutate(Class = as.factor(Class)) %>%
GO_results %>%
mutate(Class = as.factor(Class)) %>%
group_by(Class) %>%
summarise(genes = sum(Significant))
GO_results %>%
mutate(Class = as.factor(Class)) %>%
group_by(Class) %>%
summarise(genes = sum(Significant))
GO_results %>%
mutate(Class = as.factor(Class)) %>%
dplyr::group_by(Class) %>%
summarise(genes = sum(Significant))
GO_results
GO_results %>%
mutate(Class = as.factor(Class))
GO_results %>%
mutate(Class = as.factor(Class)) %>%
dplyr::group_by(Class) %>%
summarise(genes = sum(Significant))
GO_results %>%
filter(Class == "Biological_Process") %>%
summarise(genes = sum(Significant))
GO_results %>%
filter(Class == "Molecular_Function") %>%
summarise(genes = sum(Significant))
GO_results %>%
filter(Class == "Cellular_Component") %>%
summarise(genes = sum(Significant))
GO_results
slim_results
slim_results<-read_csv("5_GO/GOslim_enrichment_Acer_host.csv")
slim_results
